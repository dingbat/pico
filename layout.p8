pico-8 cartridge // http://www.pico-8.com
version 39
__lua__
units={}

for i=1,40 do
	add(units,{id=i,x=25,y=25})
end

n=0
cls()
function _draw()
--	local x,y=spiral(n)
--	pset(64+x+rnd(4)-2,
--		64+y+rnd(4)-2,8)
--	n+=1
--	if (true) return
	cls()
	map()
	foreach(units,function(u)
		spr(2,u.x,u.y)
	end)
end

function _update()
	pos={}
	foreach(units,function(u)
		u.x,u.y=25,25
	end)
	foreach(units,box)
--	foreach(units,adj_rand)
--	foreach(units,adj_smart)
	foreach(units,adj_sp)

end
	--printh("unit "..u.id.." overlaps","log")

function adj_sp(u)
	local x,y,n=u.x,u.y,1
	while g(pos,x\4,y\4) do
		local dx,dy=spiral(n)
		x,y=u.x+dx+rnd(4)-2,
			u.y+dy+rnd(4)-2
--		if wall(x\8,y\8) then
--			x,y=u.x,u.y
--		end
		n+=1
	end
	u.x,u.y=x,y
	s(pos,x\4,y\4,1)
end

function adj_smart(u)
	x,y=u.x,u.y
	if g(pos,x\4,y\4) then
		local fr,v={{u.x8,u.y8}},{}
		for p in all(fr) do
			local px,py=unpack(p)
			for xo=0,7 do
				for yo=0,7 do
					x,y=px*8+xo,py*8+yo
					if not g(pos,x\4,y\4) then
						u.x,u.y=x+rnd(3)-1.5,y+rnd(3)-1.5
						goto done
					end
				end
			end
			surr(function(t)
				if not v[t.k] then
					v[t.k]=add(fr,t)
				end
			end,px,py,1)
		end
	end
	::done::
	s(pos,x\4,y\4,1)
end

function adj_rand(u)
	x,y=u.x,u.y
	while g(pos,x\4,y\4,wall(x\8,y\8)) do
		x+=rnd(split"-1,-.5,0,0,.5,1")
		y+=rnd(split"-1,-.5,0,0,.5,1")
		if wall(x\8,y\8) then
			x,y=u.x,u.y
		end
		u.x,u.y=x,y
	end
	s(pos,x\4,y\4,1)
end

function wall(x,y)
	return fget(mget(x,y),0)
end
-->8

function g(a,x,y,def)
	return a[x|y<<8] or def
end

function s(a,x,y,v)
	a[x|y<<8]=v
end

function surr(fn,x,y,n,na)
	local n,e=n or 1
	for dx=-n,n do
	for dy=-n,n do
		local xx,yy=x+dx,y+dy
		if
			min(xx,yy)>=0 and
			xx<48 and yy<32 and
			(na or acc(xx,yy))
		then
			if (dx|dy!=0) e=1
			if fn then
				fn{
					xx,yy,
					d=dx&dy!=0 and 1.4 or 1,
					k=xx|yy<<8
				}
			end
		end
	end
	end
	return e
end

function acc(x,y)
	return true
end

function box(u)
	u.x8,u.y8=u.x\8,u.y\8
end
-->8
function _spiral(n, a)
 a = a or 1
 local theta = sqrt(n) * 3.14159
 local x = a * theta * cos(theta)
 local y = a * theta * sin(theta)
 return x, y
end

function spiral(i)
	a=3
	b=3
	angle = 0.1 * i
 x = (a + b * angle) * cos(angle)
	y = (a + b * angle) * sin(angle)
	return x,y
end

__gfx__
00000000dddddddd1110000022222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d555555d181000002eeeeee2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700d555555d111000002eeeeee2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000d555555d000000002eeeeee2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000d555555d000000002eeeeee2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700d555555d000000002eeeeee2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000d555555d000000002eeeeee2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000dddddddd0000000022222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010103010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010103010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010103010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010103010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010103010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010103010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010103010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010103010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
